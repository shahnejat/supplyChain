{"ast":null,"code":"import update from \"immutability-helper\";\nimport { UNIT_PRICE_A, UNIT_PRICE_B } from \"./constants.js\";\nimport { STORAGE_UNIT_COST_A, STORAGE_UNIT_COST_B, STORAGE_UNIT_COST_C } from \"./constants\";\nimport companyCatalogue from \"./constants.js\";\nexport class Core {\n  constructor() {\n    this.weeks = [];\n  }\n\n  createWeek() {\n    return {\n      simInput: {\n        demands: {\n          a: 0,\n          b: 0,\n          c: 0\n        },\n        sells: {\n          a: 0,\n          b: 0,\n          c: 0\n        },\n        orders: [{\n          supplierId: \"KW\",\n          a: 0,\n          b: 0,\n          c: 0\n        }, {\n          supplierId: \"WWR\",\n          a: 0,\n          b: 0,\n          c: 0\n        }, {\n          supplierId: \"ADD\",\n          a: 0,\n          b: 0,\n          c: 0\n        }, {\n          supplierId: \"IP\",\n          a: 0,\n          b: 0,\n          c: 0\n        }, {\n          supplierId: \"DP\",\n          a: 0,\n          b: 0,\n          c: 0\n        }]\n      },\n      simOutput: {\n        weekStart: {\n          stockA: 0,\n          stockB: 0,\n          stockC: 0\n        },\n        weekEnd: {\n          stockA: 0,\n          stockB: 0,\n          stockC: 0\n        },\n        results: {\n          income: 0,\n          storageCost: 0,\n          ordersCost: 0,\n          profit: 0,\n          accumulatedProfit: 0\n        }\n      }\n    };\n  }\n\n  updateIncome(newState, sellsA, sellsB) {\n    const newIncome = sellsA * UNIT_PRICE_A + sellsB * UNIT_PRICE_B;\n    return update(newState, {\n      week: {\n        simOutput: {\n          results: {\n            income: {\n              $set: newIncome\n            }\n          }\n        }\n      }\n    });\n  }\n\n  updateWeekendStock(newState, startStock, sells) {\n    return update(newState, {\n      week: {\n        simOutput: {\n          weekEnd: {\n            $set: {\n              stockA: startStock.stockA - sells.a,\n              stockB: startStock.stockB - sells.b,\n              stockC: startStock.stockC - sells.c\n            }\n          }\n        }\n      }\n    });\n  }\n\n  updateStorageCost(newState, weekstartStock, weekendStock) {\n    const weeklyStorageCost1 = (weekstartStock.stockA + weekendStock.stockA) / 2 * STORAGE_UNIT_COST_A;\n    const weeklyStorageCost2 = (weekstartStock.stockB + weekendStock.stockB) / 2 * STORAGE_UNIT_COST_B;\n    const weeklyStorageCost3 = (weekstartStock.stockC + weekendStock.stockC) / 2 * STORAGE_UNIT_COST_C;\n    const totalWeeklyStorageCost = (weeklyStorageCost1 + weeklyStorageCost2 + weeklyStorageCost3).toFixed(2);\n    return update(newState, {\n      week: {\n        simOutput: {\n          results: {\n            storageCost: {\n              $set: totalWeeklyStorageCost\n            }\n          }\n        }\n      }\n    });\n  }\n\n  updateProfit(newState) {\n    const income = newState.week.simOutput.results.income;\n    const totalWeeklyStorageCost = newState.week.simOutput.results.storageCost;\n    const totalOrderCost = newState.week.simOutput.results.ordersCost;\n    const profit = income - totalWeeklyStorageCost - totalOrderCost;\n    return update(newState, {\n      week: {\n        simOutput: {\n          results: {\n            profit: {\n              $set: profit\n            }\n          }\n        }\n      }\n    });\n  }\n\n  currentWeekIndex() {\n    return this.weeks.length - 1 + 1\n    /* current week is not pushed yet */\n    - 1\n    /* previous week */\n    ;\n  }\n\n  updateAccumulatedProfit(newState) {\n    // Compute the accumulated profit\n    const index = this.currentWeekIndex();\n    let cumulativeProfit;\n    console.log(index);\n\n    if (index >= 0) {\n      cumulativeProfit = newState.week.simOutput.results.profit + this.weeks[index].simOutput.results.accumulatedProfit;\n    } else {\n      cumulativeProfit = newState.week.simOutput.results.profit;\n    }\n\n    return update(newState, {\n      week: {\n        simOutput: {\n          results: {\n            accumulatedProfit: {\n              $set: cumulativeProfit\n            }\n          }\n        }\n      }\n    });\n  }\n\n  updateProfitSubTree(newState) {\n    return this.updateAccumulatedProfit(this.updateProfit(newState));\n  }\n\n  updateSells(state, event) {\n    const sells = state.week.simInput.sells;\n    const sellsProduct2 = event.name === \"A\" ? sells.b : sells.a;\n    const sellsProduct1 = isNaN(parseInt(event.value)) ? 0 : parseInt(event.value); // Update the state with the new input.\n\n    let newState = update(state, {\n      week: {\n        simInput: {\n          sells: {\n            [event.name.toLowerCase()]: {\n              $set: sellsProduct1\n            }\n          }\n        }\n      }\n    }); // Compute the new sells of C and update the state.\n\n    newState = update(newState, {\n      week: {\n        simInput: {\n          sells: {\n            c: {\n              $set: sellsProduct1 + sellsProduct2\n            }\n          }\n        }\n      }\n    }); // Compute and update the new income.\n    // TODO: Error check (=IF(OR((G4>E4),(H4>F4)),\"ERROR\",G4*$'Prix de vente'.$A$2+H4*$'Prix de vente'.$B$2))\n\n    newState = event.name === \"A\" ? this.updateIncome(newState, sellsProduct1, sellsProduct2) : this.updateIncome(newState, sellsProduct2, sellsProduct1); // Update week end stock.\n\n    const startStock = newState.week.simOutput.weekStart;\n    newState = this.updateWeekendStock(newState, startStock, newState.week.simInput.sells); // Compute the storage cost.\n\n    newState = this.updateStorageCost(newState, newState.week.simOutput.weekStart, newState.week.simOutput.weekEnd); // Compute the profit and accumulated profit\n\n    newState = this.updateProfitSubTree(newState);\n    return newState;\n  }\n\n  updateDemands(state, event) {\n    const demandsProduct1 = isNaN(parseInt(event.value)) ? 0 : parseInt(event.value); // Update the state with the new input.\n\n    let newState = update(state, {\n      week: {\n        simInput: {\n          demands: {\n            [event.name.toLowerCase()]: {\n              $set: demandsProduct1\n            }\n          }\n        }\n      }\n    });\n    return newState;\n  }\n\n  updateOrders(state, event) {\n    const supplierId = state.supplier.info.id;\n    const indexSupplier = state.week.simInput.orders.findIndex(ele => ele.supplierId === supplierId);\n    const value = isNaN(parseInt(event.value)) ? 0 : parseInt(event.value); // Update the state with the new input.\n\n    let newState = update(state, {\n      week: {\n        simInput: {\n          orders: {\n            [indexSupplier]: {\n              [event.name.toLowerCase()]: {\n                $set: value\n              }\n            }\n          }\n        }\n      }\n    }); // Compute the net order cost of units for KW excluding the shipping cost\n\n    let computedOrderCostForAKW = 0;\n    let computedOrderCostForBKW = 0;\n    let computedShippingCostByKW = 0;\n    let computedShippingCostByWWR = 0;\n    let orderCostFromADD = 0;\n    let orderCostFromIP = 0;\n    let orderCostFromDP = 0;\n    let receptionCostForKW = 0;\n    let receptionCostForWWR = 0;\n    let receptionCostForADD = 0;\n    let receptionCostForIP = 0;\n    let receptionCostForDP = 0;\n    let new_OrderCost_AWWR = 0;\n    let new_OrderCost_BWWR = 0;\n    let new_OrderCost_CWWR = 0;\n    let new_OrderCost_ABCWWR = 0;\n    let new_OrderCost_AKW = 0;\n    let new_OrderCost_BKW = 0;\n    let new_OrderCost_CKW = 0;\n    let new_OrderCost_ABCKW = 0;\n\n    if (state.week.simInput.orders[0].a > companyCatalogue.KW.DISCOUNT_UNIT_THRESHOLD) {\n      new_OrderCost_AKW = state.week.simInput.orders[0].a * companyCatalogue.KW.UNIT_PRICE_A_ABOVE_DISCOUNT_THRESHOLD; //computedOrderCostForAKW =\n      //companyCatalogue.KW.UNIT_PRICE_A_ABOVE_DISCOUNT_THRESHOLD;\n    } else {\n      new_OrderCost_AKW = state.week.simInput.orders[0].a * companyCatalogue.KW.UNIT_PRICE_A_BELOW_DISCOUNT_THRESHOLD; //computedOrderCostForAKW =\n      //companyCatalogue.KW.UNIT_PRICE_A_BELOW_DISCOUNT_THRESHOLD;\n    }\n\n    if (state.week.simInput.orders[0].b > companyCatalogue.KW.DISCOUNT_UNIT_THRESHOLD) {\n      new_OrderCost_BKW = state.week.simInput.orders[0].b * companyCatalogue.KW.UNIT_PRICE_B_ABOVE_DISCOUNT_THRESHOLD; //computedOrderCostForBKW =\n      //companyCatalogue.KW.UNIT_PRICE_B_ABOVE_DISCOUNT_THRESHOLD;\n    } else {\n      new_OrderCost_BKW = state.week.simInput.orders[0].b * companyCatalogue.KW.UNIT_PRICE_B_BELOW_DISCOUNT_THRESHOLD; //computedOrderCostForBKW =\n      //companyCatalogue.KW.UNIT_PRICE_B_BELOW_DISCOUNT_THRESHOLD;\n    } // Compute the shipping cost for KW\n\n\n    if (state.week.simInput.orders[0].a + state.week.simInput.orders[0].c > 0) {\n      if (state.week.simInput.orders[0].a * computedOrderCostForAKW + state.week.simInput.orders[0].b * computedOrderCostForBKW + state.week.simInput.orders[0].c * companyCatalogue.KW.UNIT_PRICE_C_BELOW_DISCOUNT_THRESHOLD > companyCatalogue.KW.FREE_SHIPPING_THRESHOLD) {\n        computedShippingCostByKW = 0;\n      } else computedShippingCostByKW = companyCatalogue.KW.TYPICAL_SHIPPING_COST;\n    } else {\n      computedShippingCostByKW = 0;\n    } // Compute the shipping cost for WWR\n\n\n    if (state.week.simInput.orders[1].a + state.week.simInput.orders[1].c > 0) {\n      if (state.week.simInput.orders[1].a * companyCatalogue.WWR.UNIT_PRICE_A_ABOVE_DISCOUNT_THRESHOLD + state.week.simInput.orders[1].b * companyCatalogue.WWR.UNIT_PRICE_B_ABOVE_DISCOUNT_THRESHOLD + state.week.simInput.orders[1].c * companyCatalogue.WWR.UNIT_PRICE_C_ABOVE_DISCOUNT_THRESHOLD > companyCatalogue.WWR.FREE_SHIPPING_THRESHOLD) {\n        computedShippingCostByWWR = 0;\n      } else {\n        computedShippingCostByWWR = companyCatalogue.WWR.TYPICAL_SHIPPING_COST;\n      }\n    } else {\n      computedShippingCostByWWR = 0;\n    } // Compute the net oder cost of units for ADD, IP, and DP respectively, excluding the shipping cost\n\n\n    orderCostFromADD = state.week.simInput.orders[2].a * companyCatalogue.ADD.UNIT_PRICE_A_ABOVE_DISCOUNT_THRESHOLD;\n    orderCostFromIP = state.week.simInput.orders[3].b * companyCatalogue.IP.UNIT_PRICE_B_ABOVE_DISCOUNT_THRESHOLD;\n    orderCostFromDP = state.week.simInput.orders[4].c * companyCatalogue.DP.UNIT_PRICE_C_ABOVE_DISCOUNT_THRESHOLD; // Compute the reception cost for KW, WWR, ADD, IP, and DP respectively\n\n    if (state.week.simInput.orders[0].a + state.week.simInput.orders[0].c > 0) {\n      receptionCostForKW = companyCatalogue.KW.RECEPTION_COST;\n    }\n\n    if (state.week.simInput.orders[1].a + state.week.simInput.orders[1].c > 0) {\n      receptionCostForWWR = companyCatalogue.WWR.RECEPTION_COST;\n    }\n\n    if (state.week.simInput.orders[2].a > 0) {\n      receptionCostForADD = companyCatalogue.ADD.RECEPTION_COST;\n    }\n\n    if (state.week.simInput.orders[3].b > 0) {\n      receptionCostForIP = companyCatalogue.IP.RECEPTION_COST;\n    }\n\n    if (state.week.simInput.orders[4].c > 0) {\n      receptionCostForDP = companyCatalogue.DP.RECEPTION_COST;\n    }\n\n    const totalOrderCost = new_OrderCost_ABCKW + new_OrderCost_ABCWWR + computedShippingCostByKW + computedShippingCostByWWR + orderCostFromADD + orderCostFromIP + orderCostFromDP + receptionCostForKW + receptionCostForWWR + receptionCostForADD + receptionCostForIP + receptionCostForDP;\n    newState = update(newState, {\n      week: {\n        simOutput: {\n          results: {\n            ordersCost: {\n              $set: totalOrderCost\n            }\n          }\n        }\n      }\n    }); // update the profit and accumulated profit\n\n    newState = this.updateProfitSubTree(newState);\n    return newState;\n  }\n\n  simulate(state, event) {\n    if (event.action === \"Sells\") {\n      return this.updateSells(state, event);\n    } else if (event.action === \"Demands\") {\n      return this.updateDemands(state, event);\n    } else if (event.action === \"Orders\") {\n      return this.updateOrders(state, event);\n    } else return {};\n  }\n\n  supplierSelected(state, supplier) {\n    let newState = update(state, {\n      supplier: {\n        info: {\n          $set: supplier\n        }\n      }\n    });\n    if (supplier.id === \"ADD\") newState = update(newState, {\n      supplier: {\n        enabledOrders: {\n          $set: {\n            a: true,\n            b: false,\n            c: false\n          }\n        }\n      }\n    });else if (supplier.id === \"IP\") newState = update(newState, {\n      supplier: {\n        enabledOrders: {\n          $set: {\n            a: false,\n            b: true,\n            c: false\n          }\n        }\n      }\n    });else if (supplier.id === \"DP\") newState = update(newState, {\n      supplier: {\n        enabledOrders: {\n          $set: {\n            a: false,\n            b: false,\n            c: true\n          }\n        }\n      }\n    });else newState = update(newState, {\n      supplier: {\n        enabledOrders: {\n          $set: {\n            a: true,\n            b: true,\n            c: true\n          }\n        }\n      }\n    });\n    return newState;\n  }\n\n  initWeek() {\n    return this.createWeek();\n  }\n\n  updateWeekstartSupplier(newState, deliveryTime, supplierId, includeWeekend) {\n    let index = this.currentWeekIndex() - deliveryTime;\n\n    if (index >= 0) {\n      const orders = this.weeks[index].simInput.orders.find(ele => ele.supplierId === supplierId);\n      const {\n        stockA,\n        stockB,\n        stockC\n      } = includeWeekend === true ? this.weeks[index].simOutput.weekEnd : {\n        stockA: 0,\n        stockB: 0,\n        stockC: 0\n      };\n      return update(newState, {\n        week: {\n          simOutput: {\n            weekStart: {\n              $set: {\n                stockA: newState.week.simOutput.weekStart.stockA + orders.a + stockA,\n                stockB: newState.week.simOutput.weekStart.stockB + orders.b + stockB,\n                stockC: newState.week.simOutput.weekStart.stockC + orders.c + stockC\n              }\n            }\n          }\n        }\n      });\n    }\n\n    return newState;\n  }\n\n  updateWeekstartStock(newWeek) {\n    let week = this.updateWeekstartSupplier({\n      week: newWeek\n    }, 0, \"ADD\", true).week;\n    week = this.updateWeekstartSupplier({\n      week: week\n    }, 0, \"IP\", false).week;\n    week = this.updateWeekstartSupplier({\n      week: week\n    }, 0, \"DP\", false).week;\n    week = this.updateWeekstartSupplier({\n      week: week\n    }, 4, \"WWR\", false).week;\n    week = this.updateWeekstartSupplier({\n      week: week\n    }, 1, \"KW\", false).week;\n    return week;\n  }\n\n  advanceSimulation(week) {\n    // Store this week\n    this.weeks.push(week); // Create and update the next week\n\n    let newWeek = this.createWeek();\n    newWeek = this.updateWeekstartStock(newWeek);\n    newWeek = this.updateWeekendStock({\n      week: newWeek\n    }, newWeek.simOutput.weekStart, newWeek.simInput.sells).week;\n    newWeek = this.updateStorageCost({\n      week: newWeek\n    }, newWeek.simOutput.weekStart, newWeek.simOutput.weekEnd).week; // Compute the profit and accumulated profit\n\n    newWeek = this.updateProfitSubTree({\n      week: newWeek\n    }).week;\n    console.log(this.weeks);\n    return newWeek;\n  }\n\n}","map":{"version":3,"sources":["/home/amad/Downloads/supply_chain/SCG/src/core/simulate.js"],"names":["update","UNIT_PRICE_A","UNIT_PRICE_B","STORAGE_UNIT_COST_A","STORAGE_UNIT_COST_B","STORAGE_UNIT_COST_C","companyCatalogue","Core","constructor","weeks","createWeek","simInput","demands","a","b","c","sells","orders","supplierId","simOutput","weekStart","stockA","stockB","stockC","weekEnd","results","income","storageCost","ordersCost","profit","accumulatedProfit","updateIncome","newState","sellsA","sellsB","newIncome","week","$set","updateWeekendStock","startStock","updateStorageCost","weekstartStock","weekendStock","weeklyStorageCost1","weeklyStorageCost2","weeklyStorageCost3","totalWeeklyStorageCost","toFixed","updateProfit","totalOrderCost","currentWeekIndex","length","updateAccumulatedProfit","index","cumulativeProfit","console","log","updateProfitSubTree","updateSells","state","event","sellsProduct2","name","sellsProduct1","isNaN","parseInt","value","toLowerCase","updateDemands","demandsProduct1","updateOrders","supplier","info","id","indexSupplier","findIndex","ele","computedOrderCostForAKW","computedOrderCostForBKW","computedShippingCostByKW","computedShippingCostByWWR","orderCostFromADD","orderCostFromIP","orderCostFromDP","receptionCostForKW","receptionCostForWWR","receptionCostForADD","receptionCostForIP","receptionCostForDP","new_OrderCost_AWWR","new_OrderCost_BWWR","new_OrderCost_CWWR","new_OrderCost_ABCWWR","new_OrderCost_AKW","new_OrderCost_BKW","new_OrderCost_CKW","new_OrderCost_ABCKW","KW","DISCOUNT_UNIT_THRESHOLD","UNIT_PRICE_A_ABOVE_DISCOUNT_THRESHOLD","UNIT_PRICE_A_BELOW_DISCOUNT_THRESHOLD","UNIT_PRICE_B_ABOVE_DISCOUNT_THRESHOLD","UNIT_PRICE_B_BELOW_DISCOUNT_THRESHOLD","UNIT_PRICE_C_BELOW_DISCOUNT_THRESHOLD","FREE_SHIPPING_THRESHOLD","TYPICAL_SHIPPING_COST","WWR","UNIT_PRICE_C_ABOVE_DISCOUNT_THRESHOLD","ADD","IP","DP","RECEPTION_COST","simulate","action","supplierSelected","enabledOrders","initWeek","updateWeekstartSupplier","deliveryTime","includeWeekend","find","updateWeekstartStock","newWeek","advanceSimulation","push"],"mappings":"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","sourcesContent":["import update from \"immutability-helper\";\nimport { UNIT_PRICE_A, UNIT_PRICE_B } from \"./constants.js\";\nimport {\n  STORAGE_UNIT_COST_A,\n  STORAGE_UNIT_COST_B,\n  STORAGE_UNIT_COST_C,\n} from \"./constants\";\nimport companyCatalogue from \"./constants.js\";\n\nexport class Core {\n  constructor() {\n    this.weeks = []\n  }\n\n  createWeek(){\n    return {\n      simInput: {\n        demands: {a: 0, b: 0, c: 0},\n        sells: {a: 0, b: 0, c: 0},\n        orders: [\n          {supplierId: \"KW\", a: 0, b: 0, c: 0},\n          {supplierId: \"WWR\", a: 0, b: 0, c: 0},\n          {supplierId: \"ADD\", a: 0, b: 0, c: 0},\n          {supplierId: \"IP\", a: 0, b: 0, c: 0},\n          {supplierId: \"DP\", a: 0, b: 0, c: 0}\n        ]\n      },\n      simOutput: {\n        weekStart: {\n          stockA: 0,\n          stockB: 0,\n          stockC: 0\n        },\n        weekEnd: {\n          stockA: 0,\n          stockB: 0,\n          stockC: 0\n        },\n        results: {\n          income: 0,\n          storageCost: 0,\n          ordersCost: 0,\n          profit: 0,\n          accumulatedProfit: 0\n        }\n      }\n    }\n  }\n\n  updateIncome(newState, sellsA, sellsB) {\n    const newIncome = sellsA * UNIT_PRICE_A + sellsB * UNIT_PRICE_B;\n\n    return update(newState, {week: {simOutput: {results: {income: {\n      $set: newIncome}}}}});\n  }\n\n  updateWeekendStock(newState, startStock, sells) {\n    return update(newState, {\n      week: {\n        simOutput: {\n          weekEnd:  {$set: {\n            stockA: startStock.stockA - sells.a,\n            stockB: startStock.stockB - sells.b,\n            stockC: startStock.stockC - sells.c\n          }}\n        }\n      }\n    });\n  }\n\n  updateStorageCost(newState, weekstartStock, weekendStock) {\n    const weeklyStorageCost1 =\n      ((weekstartStock.stockA +\n        weekendStock.stockA) /\n        2) *\n      STORAGE_UNIT_COST_A;\n    const weeklyStorageCost2 =\n      ((weekstartStock.stockB +\n        weekendStock.stockB) /\n        2) *\n      STORAGE_UNIT_COST_B;\n    const weeklyStorageCost3 =\n      ((weekstartStock.stockC +\n        weekendStock.stockC) /\n        2) *\n      STORAGE_UNIT_COST_C;\n    const totalWeeklyStorageCost = (\n      weeklyStorageCost1 +\n      weeklyStorageCost2 +\n      weeklyStorageCost3\n    ).toFixed(2);\n    return update(newState, {\n      week: {\n        simOutput: {\n          results: { storageCost: { $set: totalWeeklyStorageCost } },\n        },\n      },\n    });\n  }\n\n  updateProfit(newState) {\n    const income = newState.week.simOutput.results.income;\n    const totalWeeklyStorageCost =  newState.week.simOutput.results.storageCost;\n    const totalOrderCost = newState.week.simOutput.results.ordersCost;\n    const profit = income - totalWeeklyStorageCost - totalOrderCost;\n\n    return update(newState, {\n      week: {\n        simOutput: {\n          results: { profit: { $set: profit } },\n        },\n      },\n    });\n  }\n\n  currentWeekIndex() {\n    return (this.weeks.length - 1 + 1 /* current week is not pushed yet */) - 1 /* previous week */;\n  }\n\n  updateAccumulatedProfit(newState) {\n    // Compute the accumulated profit\n    const index = this.currentWeekIndex();\n    let cumulativeProfit;\n    console.log(index)\n    if(index >= 0) {\n      cumulativeProfit = newState.week.simOutput.results.profit\n        + this.weeks[index].simOutput.results.accumulatedProfit;\n    } else {\n      cumulativeProfit = newState.week.simOutput.results.profit;\n    }\n    return update(newState, {\n      week: {\n        simOutput: {\n          results: { accumulatedProfit: { $set: cumulativeProfit } },\n        },\n      },\n    });\n  }\n\n  updateProfitSubTree(newState) {\n    return this.updateAccumulatedProfit(this.updateProfit(newState));\n  }\n\n  updateSells(state, event){\n    const sells = state.week.simInput.sells;\n    const sellsProduct2 = event.name === \"A\" ? sells.b : sells.a;\n    const sellsProduct1 = isNaN(parseInt(event.value)) ? 0 : parseInt(event.value);\n\n    // Update the state with the new input.\n    let newState = update(state, {week: {simInput: {sells: {[event.name.toLowerCase()]: {\n      $set: sellsProduct1}}}}});\n\n    // Compute the new sells of C and update the state.\n    newState = update(newState, {week: {simInput: {sells: {c: {\n      $set: sellsProduct1 + sellsProduct2}}}}});\n\n    // Compute and update the new income.\n    // TODO: Error check (=IF(OR((G4>E4),(H4>F4)),\"ERROR\",G4*$'Prix de vente'.$A$2+H4*$'Prix de vente'.$B$2))\n    newState = event.name === \"A\" ? this.updateIncome(newState, sellsProduct1, sellsProduct2) :\n      this.updateIncome(newState, sellsProduct2, sellsProduct1);\n\n      // Update week end stock.\n    const startStock = newState.week.simOutput.weekStart;\n    newState = this.updateWeekendStock(newState, startStock, newState.week.simInput.sells);\n\n    // Compute the storage cost.\n    newState = this.updateStorageCost(newState, newState.week.simOutput.weekStart,\n      newState.week.simOutput.weekEnd);\n\n    // Compute the profit and accumulated profit\n    newState = this.updateProfitSubTree(newState);\n\n    return newState;\n  }\n\n  updateDemands(state, event){\n    const demandsProduct1 = isNaN(parseInt(event.value)) ? 0 : parseInt(event.value);\n\n    // Update the state with the new input.\n    let newState = update(state, {week: {simInput: {demands: {[event.name.toLowerCase()]: {\n      $set: demandsProduct1}}}}});\n\n    return newState;\n  }\n\n  updateOrders(state, event){\n    const supplierId = state.supplier.info.id;\n    const indexSupplier = state.week.simInput.orders.findIndex(ele => ele.supplierId === supplierId);\n    const value = isNaN(parseInt(event.value)) ? 0 : parseInt(event.value);\n\n    // Update the state with the new input.\n    let newState = update(state, {week: {simInput: {orders: {[indexSupplier]: {\n      [event.name.toLowerCase()]: {$set: value}}}}}});\n\n    // Compute the net order cost of units for KW excluding the shipping cost\n    let computedOrderCostForAKW = 0;\n    let computedOrderCostForBKW = 0;\n    let computedShippingCostByKW = 0;\n    let computedShippingCostByWWR = 0;\n    let orderCostFromADD = 0;\n    let orderCostFromIP = 0;\n    let orderCostFromDP = 0;\n    let receptionCostForKW = 0;\n    let receptionCostForWWR = 0;\n    let receptionCostForADD = 0;\n    let receptionCostForIP = 0;\n    let receptionCostForDP = 0;\n\n    let new_OrderCost_AWWR = 0;\n    let new_OrderCost_BWWR = 0;\n    let new_OrderCost_CWWR = 0;\n    let new_OrderCost_ABCWWR = 0;\n    let new_OrderCost_AKW = 0;\n    let new_OrderCost_BKW = 0;\n    let new_OrderCost_CKW = 0;\n    let new_OrderCost_ABCKW = 0;\n\n    if ( state.week.simInput.orders[0].a > companyCatalogue.KW.DISCOUNT_UNIT_THRESHOLD ) {\n\tnew_OrderCost_AKW =\n        state.week.simInput.orders[0].a *\n        companyCatalogue.KW.UNIT_PRICE_A_ABOVE_DISCOUNT_THRESHOLD;\n      //computedOrderCostForAKW =\n        //companyCatalogue.KW.UNIT_PRICE_A_ABOVE_DISCOUNT_THRESHOLD;\n    } else {\n\tnew_OrderCost_AKW =\n        state.week.simInput.orders[0].a *\n        companyCatalogue.KW.UNIT_PRICE_A_BELOW_DISCOUNT_THRESHOLD;\n      //computedOrderCostForAKW =\n        //companyCatalogue.KW.UNIT_PRICE_A_BELOW_DISCOUNT_THRESHOLD;\n    }\n\n    if ( state.week.simInput.orders[0].b > companyCatalogue.KW.DISCOUNT_UNIT_THRESHOLD ) {\n\tnew_OrderCost_BKW =\n        state.week.simInput.orders[0].b *\n        companyCatalogue.KW.UNIT_PRICE_B_ABOVE_DISCOUNT_THRESHOLD;      \n\t//computedOrderCostForBKW =\n        //companyCatalogue.KW.UNIT_PRICE_B_ABOVE_DISCOUNT_THRESHOLD;\n    } else {\n\tnew_OrderCost_BKW =\n        state.week.simInput.orders[0].b *\n        companyCatalogue.KW.UNIT_PRICE_B_BELOW_DISCOUNT_THRESHOLD;\n      //computedOrderCostForBKW =\n        //companyCatalogue.KW.UNIT_PRICE_B_BELOW_DISCOUNT_THRESHOLD;\n    }\n\n    // Compute the shipping cost for KW\n    if ( state.week.simInput.orders[0].a + state.week.simInput.orders[0].c > 0 ) {\n      if (\n        state.week.simInput.orders[0].a * computedOrderCostForAKW +\n          state.week.simInput.orders[0].b * computedOrderCostForBKW +\n          state.week.simInput.orders[0].c *\n            companyCatalogue.KW.UNIT_PRICE_C_BELOW_DISCOUNT_THRESHOLD >\n        companyCatalogue.KW.FREE_SHIPPING_THRESHOLD\n      ) {\n        computedShippingCostByKW = 0;\n      } else\n        computedShippingCostByKW =\n          companyCatalogue.KW.TYPICAL_SHIPPING_COST;\n    } else {\n      computedShippingCostByKW = 0;\n    }\n\n    // Compute the shipping cost for WWR\n    if ( state.week.simInput.orders[1].a + state.week.simInput.orders[1].c > 0 ) {\n      if (\n        state.week.simInput.orders[1].a *\n          companyCatalogue.WWR.UNIT_PRICE_A_ABOVE_DISCOUNT_THRESHOLD +\n          state.week.simInput.orders[1].b *\n            companyCatalogue.WWR.UNIT_PRICE_B_ABOVE_DISCOUNT_THRESHOLD +\n          state.week.simInput.orders[1].c *\n            companyCatalogue.WWR.UNIT_PRICE_C_ABOVE_DISCOUNT_THRESHOLD >\n        companyCatalogue.WWR.FREE_SHIPPING_THRESHOLD\n      ) {\n        computedShippingCostByWWR = 0;\n      } else {\n        computedShippingCostByWWR =\n          companyCatalogue.WWR.TYPICAL_SHIPPING_COST;\n      }\n    } else {\n      computedShippingCostByWWR = 0;\n    }\n\n    // Compute the net oder cost of units for ADD, IP, and DP respectively, excluding the shipping cost\n    orderCostFromADD =\n      state.week.simInput.orders[2].a *\n      companyCatalogue.ADD.UNIT_PRICE_A_ABOVE_DISCOUNT_THRESHOLD;\n    orderCostFromIP =\n      state.week.simInput.orders[3].b *\n      companyCatalogue.IP.UNIT_PRICE_B_ABOVE_DISCOUNT_THRESHOLD;\n    orderCostFromDP =\n      state.week.simInput.orders[4].c *\n      companyCatalogue.DP.UNIT_PRICE_C_ABOVE_DISCOUNT_THRESHOLD;\n\n    // Compute the reception cost for KW, WWR, ADD, IP, and DP respectively\n    if ( state.week.simInput.orders[0].a + state.week.simInput.orders[0].c > 0 ) {\n      receptionCostForKW = companyCatalogue.KW.RECEPTION_COST;\n    }\n    if ( state.week.simInput.orders[1].a + state.week.simInput.orders[1].c > 0 ) {\n      receptionCostForWWR = companyCatalogue.WWR.RECEPTION_COST;\n    }\n    if (state.week.simInput.orders[2].a > 0) {\n      receptionCostForADD = companyCatalogue.ADD.RECEPTION_COST;\n    }\n    if (state.week.simInput.orders[3].b > 0) {\n      receptionCostForIP = companyCatalogue.IP.RECEPTION_COST;\n    }\n    if (state.week.simInput.orders[4].c > 0) {\n      receptionCostForDP = companyCatalogue.DP.RECEPTION_COST;\n    }\n    const totalOrderCost =\n\n      new_OrderCost_ABCKW +\n      new_OrderCost_ABCWWR +\n\n      computedShippingCostByKW +\n      computedShippingCostByWWR +\n      orderCostFromADD +\n      orderCostFromIP +\n      orderCostFromDP +\n      receptionCostForKW +\n      receptionCostForWWR +\n      receptionCostForADD +\n      receptionCostForIP +\n      receptionCostForDP;\n\n    newState = update(newState, {\n      week: {\n        simOutput: {\n          results: { ordersCost: { $set: totalOrderCost } },\n        },\n      },\n    });\n\n    // update the profit and accumulated profit\n    newState = this.updateProfitSubTree(newState);\n\n    return newState;\n  }\n\n  simulate(state, event) {\n    if(event.action === \"Sells\") {\n      return this.updateSells(state, event);\n    }\n    else if(event.action === \"Demands\") {\n      return this.updateDemands(state, event);\n    }\n    else if (event.action === \"Orders\") {\n      return this.updateOrders(state, event);\n    }\n    else\n      return {}\n  }\n\n  supplierSelected(state, supplier) {\n    let newState = update(state, {supplier: {info: {$set: supplier}}});\n    if(supplier.id === \"ADD\")\n      newState = update(newState, {supplier: {enabledOrders: {$set:  {a: true, b: false, c: false}}}});\n    else if(supplier.id === \"IP\")\n      newState = update(newState, {supplier: {enabledOrders: {$set:  {a: false, b: true, c: false}}}});\n    else if(supplier.id === \"DP\")\n      newState = update(newState, {supplier: {enabledOrders: {$set:  {a: false, b: false, c: true}}}});\n    else\n     newState = update(newState, {supplier: {enabledOrders: {$set:  {a: true, b: true, c: true}}}});\n\n    return newState;\n  }\n\n  initWeek() {\n    return this.createWeek();\n  }\n\n  updateWeekstartSupplier(newState, deliveryTime, supplierId, includeWeekend){\n    let index = this.currentWeekIndex() - deliveryTime;\n    if(index >= 0) {\n      const orders = this.weeks[index].simInput.orders.find(ele => ele.supplierId === supplierId);\n      const {stockA, stockB, stockC} = includeWeekend===true ? this.weeks[index].simOutput.weekEnd :\n        {stockA: 0, stockB: 0, stockC: 0};\n\n      return update(newState, {\n        week: {\n          simOutput: {\n            weekStart:  {$set: {\n              stockA: newState.week.simOutput.weekStart.stockA + orders.a + stockA,\n              stockB: newState.week.simOutput.weekStart.stockB + orders.b + stockB,\n              stockC: newState.week.simOutput.weekStart.stockC + orders.c + stockC\n            }}\n          }\n        }\n      });\n    }\n    return newState;\n  }\n\n  updateWeekstartStock(newWeek){\n    let week = this.updateWeekstartSupplier({week: newWeek}, 0, \"ADD\", true).week;\n    week = this.updateWeekstartSupplier({week: week}, 0, \"IP\", false).week;\n    week = this.updateWeekstartSupplier({week: week}, 0, \"DP\", false).week;\n    week = this.updateWeekstartSupplier({week: week}, 4, \"WWR\", false).week;\n    week = this.updateWeekstartSupplier({week: week}, 1, \"KW\", false).week;\n\n    return week;\n  }\n\n  advanceSimulation(week) {\n    // Store this week\n    this.weeks.push(week);\n\n    // Create and update the next week\n    let newWeek = this.createWeek();\n\n    newWeek = this.updateWeekstartStock(newWeek)\n    newWeek = this.updateWeekendStock({week: newWeek}, newWeek.simOutput.weekStart,\n      newWeek.simInput.sells).week;\n    newWeek = this.updateStorageCost({week: newWeek}, newWeek.simOutput.weekStart,\n      newWeek.simOutput.weekEnd).week;\n\n    // Compute the profit and accumulated profit\n    newWeek = this.updateProfitSubTree({week: newWeek}).week;\n\n    console.log(this.weeks);\n    return newWeek;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}